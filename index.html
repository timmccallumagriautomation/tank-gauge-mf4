<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tank Telemetry</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{ --ink:#111827; --muted:#6b7280; --card:#ffffff; --ring:#e5e7eb; --accent:#ef4444; }
    body{ background:#fff; color:var(--ink); }
    .card{ background:var(--card); border:1px solid var(--ring);
           box-shadow:0 1px 2px rgba(0,0,0,.04), 0 8px 24px rgba(0,0,0,.06);
           border-radius:14px; }
    .h1-tight{ letter-spacing:.2px }
    #gauge{ width:100%; height:360px }
    #map{ width:100%; height:360px; border-radius:10px }
    .value-lg{ font-weight:700; font-size:clamp(26px,4.5vw,56px) }
    .muted{ color:var(--muted) }
    .btn-estop{ background:var(--accent); border:none; color:#fff; font-weight:700;
                padding:1.1rem 1.6rem; border-radius:12px; letter-spacing:.5px;
                box-shadow:0 10px 20px rgba(239,68,68,.25); }
    .btn-estop:hover{ filter:saturate(110%) brightness(.98) }
    .panel-center{ display:flex; align-items:center; justify-content:center; min-height:360px; text-align:center }
    pre.json{ background:#f8fafc; border:1px solid var(--ring); border-radius:10px;
              padding:12px; max-height:300px; overflow:auto; font-size:.9rem; }
    .kpi{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .kpi .pill{ border:1px solid var(--ring); border-radius:999px; padding:.35rem .75rem; background:#fff; font-size:.9rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
<div class="container-xxl py-4">
  <div class="d-flex align-items-end justify-content-between mb-3">
    <div>
      <h1 class="h4 h1-tight m-0">Tank Telemetry</h1>
      <div class="muted small">Auto-refreshing every 5 seconds</div>
    </div>
    <div class="kpi">
      <div class="pill"><span class="muted">Updated:</span> <span id="updated">—</span></div>
      <div class="pill"><span class="muted">Scale:</span> <span id="scale">0–2000 L</span></div>
      <div class="pill mono"><span class="muted">A1 E/F:</span> <span id="calA1E">—</span>/<span id="calA1F">—</span></div>
      <div class="pill mono"><span class="muted">L E/F:</span> <span id="calLE">—</span>/<span id="calLF">—</span></div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card p-3 h-100">
        <div id="gauge"></div>
        <div class="d-flex align-items-center justify-content-between mt-1">
          <div class="value-lg"><span id="litres">—</span> <span class="muted">L</span></div>
          <div class="text-end">
            <div class="muted">S3</div>
            <div id="s3key" class="small text-truncate mono" style="max-width:360px">—</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3 h-100">
        <div id="map"></div>
        <div class="d-flex align-items-center justify-content-between mt-2">
          <div><span class="muted">Lat</span> <span id="lat">—</span> &nbsp;|&nbsp; <span class="muted">Lng</span> <span id="lng">—</span></div>
          <div class="muted">Breadcrumbs: <span id="crumbs">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-lg-6">
      <div class="card p-3 h-100 panel-center">
        <div>
          <button id="estop" class="btn btn-estop btn-lg">⛔ EMERGENCY STOP</button>
          <div id="estopMsg" class="mt-3 muted small">Endpoint not configured.</div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3 h-100">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 m-0">Live payload</h2>
          <div class="d-flex gap-2">
            <button id="copyBtn" class="btn btn-outline-secondary btn-sm">Copy JSON</button>
            <a id="dl" class="btn btn-outline-dark btn-sm" download="latest.json">Download</a>
          </div>
        </div>
        <pre class="json mono" id="jsonBox">{}</pre>
      </div>
    </div>
  </div>
</div>

<script>
const CONFIG = { dataUrl: 'latest.json', pollMs: 5000, stopEndpoint: '' };

const gauge = echarts.init(document.getElementById('gauge'), null, { renderer:'svg' });
let gaugeMax = 2000;
const baseGaugeOption = (val=0, max=2000) => ({
  backgroundColor: 'transparent',
  series: [{
    type: 'gauge', min: 0, max: max, splitNumber: 10,
    axisLine: { lineStyle: { width: 14 } },
    progress: { show: true, width: 14 },
    axisTick: { show: false },
    splitLine: { length: 10, lineStyle: { width: 2, color: '#111' } },
    axisLabel: { color: '#111' },
    pointer: { itemStyle: { color: '#111' } },
    anchor: { show: true, size: 6, itemStyle: { color: '#111' } },
    title: { show: false },
    detail: { valueAnimation: true, formatter: '{value} L', color: '#111', fontSize: 26, offsetCenter: [0, '60%'] },
    data: [{ value: val }]
  }]
});
gauge.setOption(baseGaugeOption(0, gaugeMax));
addEventListener('resize', () => gauge.resize());

function updateGauge(litres, capHint) {
  if (typeof capHint === 'number' && isFinite(capHint) && capHint > 0) gaugeMax = capHint;
  const v = Number(litres) || 0;
  if (v > gaugeMax) gaugeMax = Math.ceil(v * 1.1 / 10) * 10;
  gauge.setOption(baseGaugeOption(v, gaugeMax));
  document.getElementById('litres').textContent = Math.round(v);
  document.getElementById('scale').textContent = `0–${gaugeMax} L`;
}

let map, curMarker, crumbLine;
function initMap() {
  map = L.map('map', { worldCopyJump:true }).setView([-35.13, 139.13], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '© OpenStreetMap' }).addTo(map);
  crumbLine = L.polyline([], { weight: 4, opacity: 0.9 }).addTo(map);
}
function updateMap(gpsCurrent, breadcrumbs) {
  if (!map || !gpsCurrent) return;
  const pos = [gpsCurrent.lat, gpsCurrent.lng];
  if (!curMarker) curMarker = L.marker(pos, { title: 'Current position' }).addTo(map);
  else curMarker.setLatLng(pos);
  const path = (breadcrumbs || []).map(p => [p.lat, p.lng]);
  crumbLine.setLatLngs(path);
  document.getElementById('lat').textContent = gpsCurrent.lat.toFixed(6);
  document.getElementById('lng').textContent = gpsCurrent.lng.toFixed(6);
  document.getElementById('crumbs').textContent = path.length;
  const pts = path.concat([pos]).filter(a=>a.length===2);
  if (pts.length > 1) map.fitBounds(pts, { padding: [20,20] });
}

async function fetchLatest() {
  const r = await fetch(`${CONFIG.dataUrl}?t=${Date.now()}`, { cache: 'no-store' });
  if (!r.ok) throw new Error('latest.json not found');
  const j = await r.json();

  updateGauge(j.litres, (typeof j.LITRES_FULL === 'number') ? j.LITRES_FULL : undefined);

  if (j.timestamp) document.getElementById('updated').textContent = new Date(j.timestamp).toLocaleString();
  document.getElementById('s3key').textContent = j.s3_key || '—';
  document.getElementById('jsonBox').textContent = JSON.stringify(j, null, 2);
  document.getElementById('dl').href = CONFIG.dataUrl;

  document.getElementById('calA1E').textContent = (j.A1_EMPTY ?? '—');
  document.getElementById('calA1F').textContent = (j.A1_FULL  ?? '—');
  document.getElementById('calLE').textContent  = (j.LITRES_EMPTY ?? '—');
  document.getElementById('calLF').textContent  = (j.LITRES_FULL  ?? '—');

  const gpsCurrent = j.gps_current || (j.lat && j.lng ? { lat:j.lat, lng:j.lng, timestamp:j.timestamp } : null);
  updateMap(gpsCurrent, j.breadcrumbs || []);
}

function startLoop() {
  fetchLatest().catch(()=>{});
  setInterval(() => fetchLatest().catch(()=>{}), CONFIG.pollMs);
}

document.getElementById('estop').addEventListener('click', async () => {
  const msg = document.getElementById('estopMsg');
  if (!CONFIG.stopEndpoint) { msg.textContent = 'No endpoint configured.'; return; }
  try {
    const r = await fetch(CONFIG.stopEndpoint, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ source:'ui', reason:'user_estop' })
    });
    if (!r.ok) throw new Error(await r.text());
    msg.textContent = 'Stop signal sent.';
  } catch (e) {
    msg.textContent = `Stop failed: ${e.message || e}`;
  }
});

initMap();
startLoop();
</script>
</body>
</html>
